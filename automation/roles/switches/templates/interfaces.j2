{% set bridge_ports = [] %}
{% set global_vlan_list = [] %}
{% set vlan_list = [] %}

# The loopback network interface
auto lo
iface lo inet loopback
   address {{node[inventory_hostname]["routing"]["lo"]}}
{% if node[inventory_hostname]["overlay"]["anycast-ip"] is defined %}
   clagd-vxlan-anycast-ip {{ node[inventory_hostname]["overlay"]["anycast-ip"]|replace("/32", "")}}
{% endif %}

auto eth0
iface eth0 inet dhcp
 vrf mgmt

auto mgmt
iface mgmt
  address 127.0.0.1/8
  vrf-table auto

{% for interface in node[inventory_hostname]["ports"] -%}
{% if node[inventory_hostname]["switching"][interface] is defined %}
  {% for vlan in node[inventory_hostname]["switching"][interface]["vlans"] -%}
     {% do global_vlan_list.append(vlan) -%}
  {% endfor %}
{% endif %}
{% endfor %}

{% for interface in node[inventory_hostname]["ports"] -%}
auto {{interface}}
iface {{interface}}
   mtu 9216
{% if node[inventory_hostname]["switching"][interface] is defined %}
{% if node[inventory_hostname]["switching"][interface]["mode"] == "access" %}
{% for vlan in node[inventory_hostname]["switching"][interface]["vlans"] -%}
   {% do bridge_ports.append(interface) -%}
   {% do vlan_list.append(vlan) -%}
{% endfor %}
   bridge-access {{ vlan_list | unique | sort | join(" ") }}
   {% set vlan_list = [] %}
{% endif %}
{% if node[inventory_hostname]["switching"][interface]["mode"] == "trunk" %}
{% for vlan in node[inventory_hostname]["switching"][interface]["vlans"] -%}
   {% do bridge_ports.append(interface) -%}
   {% do vlan_list.append(vlan) -%}
{% endfor %}
   bridge-vids {{ vlan_list | unique | sort | join(" ") }}
   {% set vlan_list = [] %}
{% endif %}
{% endif %}
{% endfor %}

{% if node[inventory_hostname]["overlay"]["vxlan"] is defined %}
{% for vxlan in node[inventory_hostname]["overlay"]["vxlan"] -%}
{% if vxlan != "vni" -%}
auto {{vxlan}}
iface {{vxlan}}
    bridge-access {{ node[inventory_hostname]["overlay"]["vxlan"][vxlan]["vlan"] }}
    bridge-arp-nd-suppress on
    bridge-learning off
    mstpctl-bpduguard yes
    mstpctl-portbpdufilter yes
    vxlan-id {{ node[inventory_hostname]["overlay"]["vxlan"][vxlan]["vlan"] }}
    vxlan-local-tunnelip {{ node[inventory_hostname]["routing"]["lo"] | replace("/32", "")}}
    {% do bridge_ports.append(vxlan) -%}
{% endif %}
{% endfor %}
{% endif %}

{% if node[inventory_hostname]["routing"]["svi"] is defined %}
{% for vlanint in node[inventory_hostname]["routing"]["svi"] -%}
{% if vlanint != "vlansvi" -%}
auto {{vlanint}}
iface {{vlanint}}
    address {{ node[inventory_hostname]["routing"]["svi"][vlanint]["ip"] }}
    vlan-id {{ node[inventory_hostname]["routing"]["svi"][vlanint]["vlan"] }}
    vlan-raw-device bridge
{% endif %}
{% endfor %}
{% endif %}

{% if global_vlan_list != [] %}
auto bridge
iface bridge
    bridge-ports {{ bridge_ports | unique | sort | join(" ") }}
    bridge-pvid 1
    bridge-vids {{ global_vlan_list | unique | sort | join(" ") }}
    bridge-vlan-aware yes
{% endif %}
